name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test microk8s

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check initial state
        run: |
          echo "=== Checking initial system state ==="
          if command -v microk8s &> /dev/null; then
            echo "✗ microk8s already installed"
            exit 1
          fi
          echo "✓ microk8s not installed"

      - name: Setup microk8s
        id: setup
        uses: ./
        with:
          version: 'latest/stable'
          addons: 'dns,storage'
          wait-for-ready: 'true'
          timeout: '300'

      - name: Verify installation
        run: |
          echo "=== Verifying installation ==="
          command -v microk8s && echo "✓ microk8s binary found" || { echo "✗ microk8s binary not found"; exit 1; }
          sg microk8s -c "microk8s status" && echo "✓ microk8s cluster is running" || { echo "✗ microk8s not running"; exit 1; }

      - name: Test kubectl access
        env:
          KUBECONFIG: ${{ steps.setup.outputs.kubeconfig }}
        run: |
          echo "=== Testing kubectl access ==="
          kubectl version --client
          kubectl cluster-info
          kubectl get nodes -o wide
          kubectl get pods -A

      - name: Deploy test workload
        env:
          KUBECONFIG: ${{ steps.setup.outputs.kubeconfig }}
        run: |
          echo "=== Deploying test workload ==="
          kubectl create deployment nginx --image=nginx:alpine
          kubectl expose deployment nginx --port=80 --type=ClusterIP
          kubectl wait --for=condition=available --timeout=120s deployment/nginx

          POD_NAME=$(kubectl get pod -l app=nginx -o jsonpath='{.items[0].metadata.name}')
          kubectl exec "$POD_NAME" -- wget -O- http://localhost:80 | grep -q "Welcome to nginx"
          echo "✓ Workload is functioning correctly"

      - name: Test pod networking
        env:
          KUBECONFIG: ${{ steps.setup.outputs.kubeconfig }}
        run: |
          echo "=== Testing pod networking ==="
          
          # Wait for CoreDNS to be ready before testing DNS resolution
          echo "Waiting for CoreDNS to be ready..."
          kubectl wait --for=condition=ready --timeout=120s pod -l k8s-app=kube-dns -n kube-system
          echo "✓ CoreDNS is ready"
          
          kubectl run connectivity-test --image=busybox:stable --restart=Never -- sleep 300
          kubectl wait --for=condition=ready --timeout=60s pod/connectivity-test

          kubectl exec connectivity-test -- nslookup google.com
          kubectl exec connectivity-test -- wget -q -O- --timeout=10 http://ifconfig.me && echo ""
          echo "✓ Pod networking is working"

          kubectl delete pod connectivity-test --ignore-not-found
